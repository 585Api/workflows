---
#--------------------------------------------------
#  发布到生产环境
#  Secrets存储在服务器上，部署时下载
#--------------------------------------------------
#

name: Deploy Go

on:
  workflow_call:
    inputs:
      SSH_USER:
        description: SSH 用户名
        required: false
        type: string
        default: root
      ROOT_DIR:
        description: 应用根目录
        required: false
        type: string
        default: /www/wwwroot
      DEPLOY_DIR:
        description: 部署目录名称
        required: false
        type: string
        default: ${{ github.event.repository.name }}
      APP_NAME:
        description: 应用名称
        required: false
        type: string
        default: ${{ github.event.repository.name }}

jobs:
  # 从服务器上下载存储secrets的文件
  set-secrets:
    runs-on: self-hosted
    steps:
      - run: cp /www/secrets secrets
      - name: 上传secrets文件
        uses: actions/upload-artifact@v2
        with:
          name: secrets
          path: secrets
          retention-days: 1

  build:
    runs-on: ubuntu-latest
    steps:
      - name: 下载项目
        uses: actions/checkout@v2.3.5
        with:
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.17
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v2
        with:
          version: latest
          args: release --rm-dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload assets
        uses: actions/upload-artifact@v2
        with:
          name: myapp
          path: dist/*

  sync:
    runs-on: ubuntu-latest
    needs: [set-secrets, build]
    steps:
      - name: 下载项目
        uses: actions/checkout@v2.3.5
      - name: 下载secrets
        uses: actions/download-artifact@v2
        with:
          name: secrets
      - name: 设置环境变量
        run: |
          source secrets
          echo "HOST=$HOST" >> $GITHUB_ENV
          echo -e $DEPLOY_KEY > ./deploy_key && chmod 600 deploy_key
      - name: 下载构件
        uses: actions/download-artifact@v2
        with:
          name: myapp
          path: dist
      - name: 同步到目标服务器
        uses: appleboy/scp-action@master
        with:
          host: ${{ env.HOST }}
          username: ${{ inputs.SSH_USER }}
          key_path: deploy_key
          source: "./dist/${{ inputs.APP_NAME }}_linux_amd64/${{ inputs.APP_NAME }}"
          target: /usr/local/bin
          strip_components: 2

  run:
    needs: sync
    runs-on: ubuntu-latest
    steps:
      - name: 下载secrets
        uses: actions/download-artifact@v2
        with:
          name: secrets
      - name: 设置环境变量
        run: source secrets && echo "HOST=$HOST" >> $GITHUB_ENV
      - name: 生成private_key
        run: source secrets && echo -e $DEPLOY_KEY > private_key
      - name: 设置软链接
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.HOST }}
          username: ${{ inputs.SSH_USER }}
          key_path: private_key
          script: |
            cd /usr/local/bin
            chmod +x ${{ inputs.APP_NAME }}
            ${{ inputs.APP_NAME }}

  clean-artifacts:
    needs: run
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: 清理构件
        uses: geekyeggo/delete-artifact@v1
        with:
          name: secrets
